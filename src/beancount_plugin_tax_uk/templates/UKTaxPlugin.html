{% extends "_layout.html" %}

{% block content %}
<div class="uk-cgt">
    <h2>UK Capital Gains And Other Taxes</h2>

    {% set report = extension.tax_report() %}
    {% if report.years %}
        <div class="year-selector">
            <div class="year-selector-left">
                <label for="tax-year">Tax Year:</label>
                <select id="tax-year" name="tax-year" onchange="showYear(this.value)">
                    {% for year in report.years %}
                        <option value="{{ year }}">{{ year }}/{{ year + 1 }}</option>
                    {% endfor %}
                </select>
            </div>
            <a href="download_spreadsheet" target="_blank" rel="noopener noreferrer" class="button">Download Spreadsheet</a>
        </div>

        {% for year in report.years %}
        <div class="year-section" id="year-{{ year }}" style="display: none;">
            <h3>Tax Year {{ year }}/{{ year + 1 }}</h3>

            <div class="summary-table">
                <h4>Summary by Category</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Number of Events</th>
                            <th>Disposal Proceeds</th>
                            <th>Allowable Costs</th>
                            <th>Total Gains</th>
                            <th>Total Losses</th>
                            <th>Total Taxable Gains</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in report.groups %}
                            {% if report.summaries[year].get(group) and group != '_total_capital_gains' %}
                            <tr>
                                <td>{{ group }}</td>
                                <td class="num">{{ report.summaries[year][group].event_count }}</td>
                                <td class="num">£{{ "{:,.2f}".format(report.summaries[year][group].disposal_proceeds) }}</td>
                                <td class="num">£{{ "{:,.2f}".format(report.summaries[year][group].allowable_cost) }}</td>
                                <td class="num gain">£{{ "{:,.2f}".format(report.summaries[year][group].total_gains) }}</td>
                                <td class="num loss">£{{ "{:,.2f}".format(report.summaries[year][group].total_losses) }}</td>
                                <td class="num {% if report.summaries[year][group].total_taxable_gains >= 0 %}gain{% else %}loss{% endif %}">£{{ "{:,.2f}".format(report.summaries[year][group].total_taxable_gains) }}</td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="6"><strong>Total Capital Gains</strong></td>
                            <td class="num {% if report.summaries[year]['_total_capital_gains'].total_taxable_gains >= 0 %}gain{% else %}loss{% endif %}">£{{ "{:,.2f}".format(report.summaries[year]['_total_capital_gains'].total_taxable_gains) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            {% for group in report.groups %}
                {% if report.events[year].get(group) and group != '_total_capital_gains' %}
                <div class="events-section">
                    <h4>{{ group }}</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Rule</th>
                                <th>Asset</th>
                                <th>Proceeds</th>
                                <th>Cost</th>
                                <th>Gain/Loss</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in report.events[year][group] %}
                            <tr>
                                <td><a href="../../journal/?time={{ event.date }}">{{ event.date }}</a></td>
                                <td>{{ event.event_type }}</td>
                                <td>{{ event.details.rule if event.details and 'rule' in event.details else '' }}</td>
                                <td>{{ event.asset }}</td>
                                <td class="num">£{{ "{:,.2f}".format(event.proceeds) }}</td>
                                <td class="num">£{{ "{:,.2f}".format(event.cost) }}</td>
                                <td class="num {% if event.gain >= 0 %}gain{% else %}loss{% endif %}">£{{ "{:,.2f}".format(event.gain) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endfor %}

        {% if report.rows %}
        <div class="detailed-rows-section">
            <h2>Detailed Transaction Rows</h2>
            <div class="rows-container">
                <table class="table rows-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Asset</th>
                            <th>Platform</th>
                            <th>Event</th>
                            <th>Rule</th>
                            <th>Currency</th>
                            <th>Buy Quantity</th>
                            <th>Buy Price</th>
                            <th>Buy Value (Currency)</th>
                            <th>Buy Value (GBP)</th>
                            <th>Sell Quantity</th>
                            <th>Sell Price</th>
                            <th>Sell Value (Currency)</th>
                            <th>Sell Value (GBP)</th>
                            <th>Fee Value (Currency)</th>
                            <th>Total Shares in Pool</th>
                            <th>Total Cost in Pool</th>
                            <th>Allowable Cost</th>
                            <th>Chargeable Gain</th>
                            <th>Comment</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in report.rows %}
                            {% if row.get('Year (int)') %}
                            <tr class="year-divider-row">
                                <td colspan="19"><strong>Summary for tax year ending {{ row.get('Year end', '') }}</strong></td>
                            </tr>
                            {% elif row.get('Next year') %}
                            <tr class="year-divider-row">
                                <td colspan="19"><strong>Tax year: {{ row.get('Next year', '') }}</strong></td>
                            </tr>
                            {% elif row.get('AssetSection') %}
                            <tr class="asset-divider-row">
                                <td colspan="19"><strong>Asset: {{ row.get('AssetSection', '') }}</strong></td>
                            </tr>
                            {% elif row.get('Date') or row.get('Event') %}
                            <tr class="{% if row.get('Event') == 'Sell' %}sell-row{% endif %}">
                                <td>{% if row.get('Date') %}<a href="../../journal/?time={{ row.get('Date') }}">{{ row.get('Date', '') }}</a>{% else %}&nbsp;{% endif %}</td>
                                <td>{{ row.get('Asset', '') or ' ' }}</td>
                                <td>{{ row.get('Platform', '') or ' ' }}</td>
                                <td>{{ row.get('Event', '') or ' ' }}</td>
                                <td>{{ row.get('Rule', '') or ' ' }}</td>
                                <td>{{ row.get('Currency', '') or ' ' }}</td>
                                <td class="num">{% set buy_qty = row.get('Buy Quantity') %}{% if buy_qty is not none and buy_qty != '' %}{{ buy_qty }}{% else %} {% endif %}</td>
                                <td class="num">{% set buy_price = row.get('Buy Price') %}{% if buy_price is not none and buy_price != '' %}{{ "{:,.2f}".format(buy_price) }}{% else %} {% endif %}</td>
                                <td class="num">{% set buy_val_curr = row.get('Buy Value in Currency') %}{% if buy_val_curr is not none and buy_val_curr != '' %}{{ "{:,.2f}".format(buy_val_curr) }}{% else %} {% endif %}</td>
                                <td class="num">{% set buy_val_gbp = row.get('Buy Value in GBP') %}{% if buy_val_gbp is not none and buy_val_gbp != '' %}£{{ "{:,.2f}".format(buy_val_gbp) }}{% else %} {% endif %}</td>
                                <td class="num">{% set sell_qty = row.get('Sell Quantity') %}{% if sell_qty is not none and sell_qty != '' %}{{ sell_qty }}{% else %} {% endif %}</td>
                                <td class="num">{% set sell_price = row.get('Sell Price') %}{% if sell_price is not none and sell_price != '' %}{{ "{:,.2f}".format(sell_price) }}{% else %} {% endif %}</td>
                                <td class="num">{% set sell_val_curr = row.get('Sell Value in Currency') %}{% if sell_val_curr is not none and sell_val_curr != '' %}{{ "{:,.2f}".format(sell_val_curr) }}{% else %} {% endif %}</td>
                                <td class="num">{% set sell_val_gbp = row.get('Sell Value in GBP') %}{% if sell_val_gbp is not none and sell_val_gbp != '' %}£{{ "{:,.2f}".format(sell_val_gbp) }}{% else %} {% endif %}</td>
                                <td class="num">{% set fee_val = row.get('Fee Value in Currency') %}{% if fee_val is not none and fee_val != '' %}{{ "{:,.2f}".format(fee_val) }}{% else %} {% endif %}</td>
                                <td class="num">{% set total_shares = row.get('Total shares in pool') %}{% if total_shares is not none and total_shares != '' %}{{ "{:,.2f}".format(total_shares) }}{% else %} {% endif %}</td>
                                <td class="num">{% set total_cost = row.get('Total cost in pool') %}{% if total_cost is not none and total_cost != '' %}£{{ "{:,.2f}".format(total_cost) }}{% else %} {% endif %}</td>
                                <td class="num">{% set allowable = row.get('Allowable cost') %}{% if allowable is not none and allowable != '' %}£{{ "{:,.2f}".format(allowable) }}{% else %} {% endif %}</td>
                                <td class="num {% set cg = row.get('Chargeable gain') %}{% if cg is not none %}{% if cg >= 0 %}gain{% else %}loss{% endif %}{% endif %}">{% if cg is not none and cg != '' %}£{{ "{:,.2f}".format(cg) }}{% else %} {% endif %}</td>
                                <td>{{ row.get('Comment', '') or ' ' }}</td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    {% else %}
        <p>No relevant transactions found in the ledger.</p>
    {% endif %}
</div>

<style>
.uk-cgt {
    padding: 1rem;
}

.year-selector {
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.year-selector-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

select {
    padding: 0.5rem;
    min-width: 150px;
    border: 1px solid var(--border);
    border-radius: 4px;
    height: 2.5rem;
    background-color: var(--background);
    color: var(--text-color);
}

.uk-cgt .button {
    padding: 0 1.5rem !important;
    background-color: var(--button-background);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: bold;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 2.5rem;
    line-height: 2.5rem;
    margin-left: auto;
    color: var(--button-color);
}

.uk-cgt .button:visited {
    color: var(--button-color);
}

.uk-cgt .button:hover {
    opacity: 0.85;
}

.year-section {
    margin-bottom: 4rem;
    padding-bottom: 2rem;
}

.year-section h3 {
    margin-bottom: 2rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-darker);
}

.summary-table {
    margin-bottom: 3rem;
}

.events-section {
    margin-bottom: 3rem;
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
}

.events-section h4 {
    margin-top: 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-lighter);
}

.num {
    text-align: right;
    font-family: var(--font-family-monospaced), monospace;
}

table.table td.gain,
table.table td.num.gain {
    color: var(--diff-green) !important;
}

table.table td.loss,
table.table td.num.loss {
    color: var(--diff-red) !important;
}

table.table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}

table.table th,
table.table td {
    padding: 0.5rem;
    border: 1px solid var(--table-border);
}

table.table th {
    font-weight: bold;
    background-color: var(--table-header-background);
    color: var(--table-header-text);
}

.total-row {
    font-weight: bold;
}

.total-row td {
    border-top: 2px solid var(--border-darker);
}

a.button:visited {
    color: var(--button-color);
}

.detailed-rows-section {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 3px solid var(--border-darker);
}

.detailed-rows-section h2 {
    margin-bottom: 2rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-darker);
}

.rows-container {
    overflow-x: auto;
}

.rows-table {
    font-size: 0.85rem;
    min-width: 100%;
}

.rows-table th {
    white-space: nowrap;
    position: sticky;
    top: 0;
    background-color: var(--table-header-background);
    z-index: 10;
}

.year-divider-row {
    background-color: light-dark(hsl(195deg 53% 79%), hsl(200deg 30% 25%));
    font-weight: bold;
}

.year-divider-row td {
    padding: 0.75rem;
    border-top: 2px solid var(--border-darker);
    border-bottom: 2px solid var(--border-darker);
}

.asset-divider-row {
    background-color: light-dark(hsl(120deg 39% 85%), hsl(125deg 20% 22%));
    font-weight: bold;
}

.asset-divider-row td {
    padding: 0.75rem;
    border-top: 1px solid var(--border-darker);
}

.sell-row {
    background-color: light-dark(hsl(45deg 100% 90%), hsl(45deg 30% 22%)) !important;
}

</style>

<!-- <script type="module">
window.showYear = UKTaxPlugin.showYear;
document.addEventListener('DOMContentLoaded', () => UKTaxPlugin.initializeTaxView());

</script> -->
{% endblock %}